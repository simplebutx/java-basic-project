<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post Detail</title>
    <link href="/css/main.css" rel="stylesheet" />
</head>
<body>
<div th:replace="~{navbar :: navbar}"></div>

<div class="page">
    <div class="detail-card">

        <h1 class="detail-title" th:text="${post.title}">ì œëª©</h1>
        <p class="detail-content" th:text="${post.content}">ë‚´ìš©</p>

        <img th:if="${post.imageUrl != null}"
             th:src="${post.imageUrl}"
             style="max-width: 600px; height: auto;" />

        <div class="detail-meta">
            <div class="meta-row">
                <span class="meta-emoji">âœï¸</span>
                <span>ì‘ì„±ì : </span>
                <span class="meta-value" th:text="${post.author}">author</span>
            </div>

            <!-- createdAtì´ ìˆìœ¼ë©´ ì´ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ í†µì§¸ë¡œ ì‚­ì œí•´ë„ ë¨ -->
            <div class="meta-row2" th:if="${post.createdAt != null}">
                <span class="meta-emoji">ğŸ•’</span>
                <span>ì‘ì„± ë‚ ì§œ : </span>
                <span class="meta-value2"
                      th:text="${#temporals.format(post.createdAt, 'yyyy. MM. dd. a h:mm')}">date</span>
            </div>

            <div class="meta-row2" th:if="${post.updatedAt != null}">
                <span class="meta-emoji">ğŸ•’</span>
                <span>ìˆ˜ì • ë‚ ì§œ : </span>
                <span class="meta-value2"
                      th:text="${#temporals.format(post.updatedAt, 'yyyy. MM. dd. a h:mm')}">date</span>
            </div>
        </div>

        <!-- ì‘ì„±ìë§Œ ë³´ì´ëŠ” ì˜ì—­ -->
        <div th:if="${post.author == #authentication.name}" class="detail-actions">

            <!-- ìˆ˜ì • (GET) -->
            <form th:action="@{/posts/{id}/edit(id=${post.id})}" method="get" style="display:inline">
                <button type="submit" class="action-btn action-edit">
                    âœï¸ <span>ìˆ˜ì •</span>
                </button>
            </form>

            <!-- ì‚­ì œ (POST) -->
            <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display:inline">
                <button type="submit" class="action-btn action-delete">
                    ğŸ—‘ ì‚­ì œ
                </button>
            </form>

        </div>

        <!-- ê´€ë¦¬ìë§Œ ë³´ì´ëŠ” ì˜ì—­ -->
        <div sec:authorize="hasAuthority('ROLE_ADMIN')" class="detail-actions">
            <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display:inline">
                <button type="submit" class="action-btn action-delete">
                    ğŸ›¡ ê´€ë¦¬ì ì‚­ì œ
                </button>
            </form>
        </div>

    </div>

    <div class="comments-section">
        <form class="comment-form" th:action="@{/posts/{id}/comments(id=${post.id})}" method="POST">
            <input class="comment-input" name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" />
            <button class="comment-submit" type="submit">ëŒ“ê¸€ë‹¬ê¸°</button>
        </form>

        <div class="comment-list">
            <div class="comment-item" th:each="comment : ${comments}">

                <div class="comment-view">
                    <p class="comment-content" th:text="${comment.content}"></p>

                    <div class="comment-bottom">
                        <div class="comment-meta">
                            <span class="comment-author" th:text="${comment.author}"></span>

                            <span class="comment-created"
                                  th:text="${#temporals.format(comment.createdAt, 'yyyy. MM. dd. a h:mm')}"></span>

                            <!-- âœ… updatedAtì´ ìˆì„ ë•Œë§Œ ë³´ì—¬ì£¼ê¸° -->
                            <span class="comment-updated"
                                  th:if="${comment.updatedAt != null}"
                                  th:text="'(ìˆ˜ì •: ' + ${#temporals.format(comment.updatedAt, 'yyyy. MM. dd. a h:mm')} + ')'"></span>
                        </div>


                        <div th:if="${comment.author == #authentication.name}" class="detail-actions">
                        <div class="comment-actions">
                            <button type="button" class="comment-edit-btn">ìˆ˜ì •</button>

                            <form th:action="@{/posts/{id}/comments/{commentId}/delete(
                    id=${post.id},
                    commentId=${comment.id}
                )}"
                                  method="post">
                                <button type="submit" class="comment-delete-btn">ì‚­ì œ</button>
                            </form>
                        </div>
                            </div>

                        <div sec:authorize="hasAuthority('ROLE_ADMIN')" class="detail-actions">
                            <form th:action="@{/posts/{id}/comments/{commentId}/delete(
                                    id=${post.id}, commentId=${comment.id})}"
                                  method="post" style="display:inline">
                                <button type="submit" class="action-btn action-delete">
                                    ğŸ›¡ ê´€ë¦¬ì ì‚­ì œ
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- ìˆ˜ì • í¼ì€ ê·¸ëŒ€ë¡œ -->
                <form class="comment-edit-form"
                      th:action="@{/posts/{id}/comments/{commentId}/edit(
            id=${post.id},
            commentId=${comment.id}
        )}"
                      method="post"
                      style="display:none;">
                    <input name="content" th:value="${comment.content}">
                    <button type="submit">ì €ì¥</button>
                    <button type="button" class="comment-cancel-btn">ì·¨ì†Œ</button>
                </form>

            </div>





        </div>
    </div>

</div>
<div id="toast" th:if="${toast}" th:data-msg="${toast}"></div>
<div id="toast-container"></div>
</body>

<script>
    document.addEventListener('click', function (e) {

      // ìˆ˜ì • ë²„íŠ¼
      if (e.target.classList.contains('comment-edit-btn')) {
        const commentItem = e.target.closest('.comment-item');

        commentItem.querySelector('.comment-view').style.display = 'none';
        commentItem.querySelector('.comment-edit-form').style.display = 'block';
      }

      // ì·¨ì†Œ ë²„íŠ¼
      if (e.target.classList.contains('comment-cancel-btn')) {
        const commentItem = e.target.closest('.comment-item');

        commentItem.querySelector('.comment-edit-form').style.display = 'none';
        commentItem.querySelector('.comment-view').style.display = 'block';
      }
    });
</script>

<script>
    const el = document.getElementById('toast');

    if (el) {
      const msg = el.dataset.msg;
      const container = document.getElementById('toast-container');

      // toast ìƒì„±
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;

      // ì´ˆê¸° ìƒíƒœ
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-8px)';

      container.appendChild(toast);

      // ë“±ì¥
      requestAnimationFrame(() => {
        toast.style.animation = 'toast-in 0.25s ease forwards';
      });

      // 2ì´ˆ í›„ ì‚¬ë¼ì§
      setTimeout(() => {
        toast.style.animation = 'toast-out 0.25s ease forwards';
        setTimeout(() => toast.remove(), 250);
      }, 2000);

      // ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¨ div ì œê±°
      el.remove();
    }
</script>
</html>

